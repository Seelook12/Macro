<rxui:ReactiveUserControl x:Class="Macro.Views.VariableManagerView"
             x:TypeArguments="vm:VariableManagerViewModel"
             xmlns:rxui="clr-namespace:ReactiveUI;assembly=ReactiveUI.Wpf"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:Macro.ViewModels"
             xmlns:views="clr-namespace:Macro.Views"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="900"
             d:DataContext="{d:DesignInstance Type=vm:VariableManagerViewModel, IsDesignTimeCreatable=False}">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 타이틀 -->
        <TextBlock Text="변수 관리 (Variable Manager)" FontSize="24" FontWeight="Bold" Margin="0,0,0,15" Foreground="#00796B"/>

        <!-- 정수 변수 섹션 -->
        <GroupBox Grid.Row="1" Header="정수 변수 (Integer Variables)" Margin="0,0,0,10" Padding="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 스코프 선택 + 추가 버튼 -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <TextBlock Text="스코프:" VerticalAlignment="Center" Margin="0,0,6,0" FontWeight="SemiBold"/>
                    <ComboBox Width="250"
                              ItemsSource="{Binding IntScopes}"
                              SelectedItem="{Binding SelectedIntScope}"
                              DisplayMemberPath="DisplayName"/>
                    <Button Content="+ 전역 변수 추가"
                            Command="{Binding AddGlobalVariableCommand}"
                            Padding="10,4" Margin="10,0,0,0"
                            Background="#E0F7FA" FontWeight="Bold" Foreground="#00695C" BorderBrush="#004D40"
                            Visibility="{Binding IsGlobalScope, Converter={StaticResource BoolToVis}}"/>
                    <Button Content="+ 그룹 변수 추가"
                            Command="{Binding AddGroupIntVariableCommand}"
                            Padding="10,4" Margin="10,0,0,0"
                            Background="#E8F5E9" FontWeight="Bold" Foreground="#2E7D32" BorderBrush="#1B5E20">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsGlobalScope}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>

                <!-- 전역 변수 DataGrid -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding DefinedVariables}"
                          AutoGenerateColumns="False" CanUserAddRows="False"
                          BorderThickness="1" BorderBrush="#E0E0E0"
                          Visibility="{Binding IsGlobalScope, Converter={StaticResource BoolToVis}}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="변수명" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="180"/>
                        <DataGridTextColumn Header="기본값" Binding="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}" Width="150"/>
                        <DataGridTextColumn Header="설명" Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTemplateColumn Width="50">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="X"
                                            Command="{Binding DataContext.RemoveGlobalVariableCommand, RelativeSource={RelativeSource AncestorType=views:VariableManagerView}}"
                                            CommandParameter="{Binding .}"
                                            Background="Transparent" BorderThickness="0" Foreground="Red" FontWeight="Bold"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- 그룹 정수 변수 DataGrid -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding CurrentGroupIntVariables}"
                          AutoGenerateColumns="False" CanUserAddRows="False"
                          BorderThickness="1" BorderBrush="#E0E0E0">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsGlobalScope}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="변수명" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="180"/>
                        <DataGridTextColumn Header="값" Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Width="100"/>
                        <DataGridTextColumn Header="설명" Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTemplateColumn Width="50">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="X"
                                            Command="{Binding DataContext.RemoveGroupIntVariableCommand, RelativeSource={RelativeSource AncestorType=views:VariableManagerView}}"
                                            CommandParameter="{Binding .}"
                                            Background="Transparent" BorderThickness="0" Foreground="Red" FontWeight="Bold"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>

        <!-- 좌표 변수 섹션 -->
        <GroupBox Grid.Row="2" Header="좌표 변수 (Coordinate Variables)" Margin="0,0,0,10" Padding="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 그룹 선택 + 추가 버튼 -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <TextBlock Text="그룹:" VerticalAlignment="Center" Margin="0,0,6,0" FontWeight="SemiBold"/>
                    <ComboBox Width="250"
                              ItemsSource="{Binding CoordScopes}"
                              SelectedItem="{Binding SelectedCoordScope}"
                              DisplayMemberPath="DisplayName"/>
                    <Button Content="+ 좌표 변수 추가"
                            Command="{Binding AddCoordVariableCommand}"
                            Padding="10,4" Margin="10,0,0,0"
                            Background="#FFF3E0" FontWeight="Bold" Foreground="#E65100" BorderBrush="#BF360C"
                            Visibility="{Binding HasCoordScope, Converter={StaticResource BoolToVis}}"/>
                </StackPanel>

                <!-- 좌표 DataGrid -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding CurrentCoordVariables}"
                          AutoGenerateColumns="False" CanUserAddRows="False"
                          BorderThickness="1" BorderBrush="#E0E0E0"
                          Visibility="{Binding HasCoordScope, Converter={StaticResource BoolToVis}}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="변수명" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="150"/>
                        <DataGridTextColumn Header="X" Binding="{Binding X, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                        <DataGridTextColumn Header="Y" Binding="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                        <DataGridTextColumn Header="설명" Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTemplateColumn Width="50">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="X"
                                            Command="{Binding DataContext.RemoveCoordVariableCommand, RelativeSource={RelativeSource AncestorType=views:VariableManagerView}}"
                                            CommandParameter="{Binding .}"
                                            Background="Transparent" BorderThickness="0" Foreground="Red" FontWeight="Bold"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- 그룹 없음 안내 -->
                <TextBlock Grid.Row="1" Text="레시피에 그룹이 없습니다. 티칭 페이지에서 그룹을 먼저 추가해주세요."
                           VerticalAlignment="Center" HorizontalAlignment="Center"
                           Foreground="#999" FontStyle="Italic">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasCoordScope}" Value="False">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </GroupBox>

        <!-- 하단 버튼 -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="저장 (Save All)" Command="{Binding SaveCommand}" Padding="20,8" Background="#4CAF50" Foreground="White" FontWeight="Bold"/>
        </StackPanel>
    </Grid>
</rxui:ReactiveUserControl>
